#!/bin/bash


# you have to run these in your system (not in chroot)
# timedatectl set-ntp true
# hwclock --systohc
# pacman -Syy


# Process before executing the script:
# loadkeys neoqwertz
# iwctl station* (if on laptop/without ethernet)
# pacman -Sy wget
# wget raw.gith* -O a
#


# This file can be directly downloaded with e.g:
# wget https://raw.githubusercontent.com/Drominito/env/master/scripts/os-install -O a

 
# visudo should be added directly (maybe just with a ln -s that exists not temporarly)

# wifi-auto-setup planned

# cpf covers visudo
# later do something with "trap"
# swapfile allocation is missing
# basic error handling is missing

# maybe some small curses application -
# so you can see the ToC on the right side
# OR (simpler) -> this script writes logs, and another script will evaluate the progress
# which will be printed in another tmux-pane


  percent=$(<$b)
# hardcoded:
# 256G


# umount -R /mnt
# something prompts out when the partitions already have fs'
# check if you have internet.
# sometimes reflector dont work. (time out)

# passwd / useradd have not been executed


#!/bin/bash
set -Eeuo pipefail

### preflight
[ "$EUID" -eq 0 ] || { echo "run as root"; exit 1; }
[ "$#" -eq 5 ] || { echo "args: efi root disk hostname user"; exit 1; }

EFI="$1"
ROOT="$2"
DISK="/dev/$3"
HOST="$4"
USER="$5"

[ -b "$DISK" ] || { echo "disk not found"; exit 1; }
for p in "$EFI" "$ROOT"; do
  [ -b "/dev/$p" ] || { echo "partition $p missing"; exit 1; }
done

trap 'umount -R /mnt 2>/dev/null || true' EXIT

### basics
loadkeys neoqwertz
timedatectl set-ntp true

### disk
sgdisk -o "$DISK"
sgdisk -n 1:0:+512M -t 1:ef00 "$DISK"
sgdisk -n 2:0:0      -t 2:8300 "$DISK"

mkfs.fat -F32 "/dev/$EFI"
mkfs.ext4 -F  "/dev/$ROOT"

mount "/dev/$ROOT" /mnt
mkdir -p /mnt/boot/efi
mount "/dev/$EFI" /mnt/boot/efi

### net + mirrors
ping -c1 archlinux.org >/dev/null
pacman -Sy --noconfirm reflector
reflector -c Germany -a 6 --sort rate --save /etc/pacman.d/mirrorlist
mkdir -p /mnt/etc/pacman.d
cp /etc/pacman.d/mirrorlist /mnt/etc/pacman.d/


### Swapfile
fallocate -l 8G /swapfile
chmod 600 /swapfile
mkswap /swapfile
swapon /swapfile
echo '/swapfile none swap defaults 0 0' >> /etc/fstab


### base
pacstrap /mnt base linux linux-firmware grub efibootmgr \
  iwd systemd-networkd sudo vim git tmux \
  intel-ucode amd-ucode

genfstab -U /mnt > /mnt/etc/fstab

### config
arch-chroot /mnt /bin/bash <<EOF
set -e
ln -sf /usr/share/zoneinfo/Europe/Berlin /etc/localtime
hwclock --systohc

echo "en_US.UTF-8 UTF-8" > /etc/locale.gen
locale-gen
echo "LANG=en_US.UTF-8" > /etc/locale.conf
echo "KEYMAP=neoqwertz" > /etc/vconsole.conf

echo "$HOST" > /etc/hostname
cat > /etc/hosts <<H
127.0.0.1 localhost
::1       localhost
127.0.1.1 $HOST.localdomain $HOST
H

useradd -m -G wheel $USER
echo "%wheel ALL=(ALL) ALL" > /etc/sudoers.d/wheel

systemctl enable iwd systemd-networkd systemd-resolved
ln -sf /run/systemd/resolve/stub-resolv.conf /etc/resolv.conf

mkinitcpio -P
grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=GRUB
grub-mkconfig -o /boot/grub/grub.cfg

echo "set root password"
passwd
echo "set user password"
passwd $USER
EOF

echo "done. reboot."

